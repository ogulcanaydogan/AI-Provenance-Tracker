name: Deploy Runtime (Pinned SHA, Legacy)

on:
  workflow_dispatch:
    inputs:
      runtime_target:
        description: "Deploy target"
        required: true
        type: choice
        options:
          - helm
          - railway
          - both
        default: both
      image_tag:
        description: "Optional image tag override (defaults to triggering commit SHA)"
        required: false
        type: string

permissions:
  contents: read
  packages: read
  actions: read

jobs:
  prepare:
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.resolve.outputs.image_tag }}
      api_image: ${{ steps.resolve.outputs.api_image }}
      worker_image: ${{ steps.resolve.outputs.worker_image }}
      deploy_helm: ${{ steps.resolve.outputs.deploy_helm }}
      deploy_railway: ${{ steps.resolve.outputs.deploy_railway }}
      runtime_target: ${{ steps.resolve.outputs.runtime_target }}
      rollback_tag: ${{ steps.resolve.outputs.rollback_tag }}
    steps:
      - name: Resolve deployment plan
        id: resolve
        env:
          INPUT_RUNTIME_TARGET: ${{ inputs.runtime_target }}
          INPUT_IMAGE_TAG: ${{ inputs.image_tag }}
          ENABLE_HELM_DEPLOY: ${{ vars.ENABLE_HELM_DEPLOY }}
          ENABLE_RAILWAY_DEPLOY: ${{ vars.ENABLE_RAILWAY_DEPLOY }}
          CURRENT_WORKFLOW_RUN_ID: ${{ github.event.workflow_run.id || '' }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            image_tag="${{ github.event.workflow_run.head_sha }}"
            runtime_target="auto"
          else
            image_tag="${INPUT_IMAGE_TAG:-}"
            runtime_target="${INPUT_RUNTIME_TARGET:-both}"
          fi

          if [ -z "$image_tag" ]; then
            image_tag="${{ github.sha }}"
          fi

          api_image="ghcr.io/${{ github.repository_owner }}/provenance-api:${image_tag}"
          worker_image="ghcr.io/${{ github.repository_owner }}/provenance-worker:${image_tag}"

          deploy_helm=false
          deploy_railway=false

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            case "$runtime_target" in
              helm)
                deploy_helm=true
                ;;
              railway)
                deploy_railway=true
                ;;
              both)
                deploy_helm=true
                deploy_railway=true
                ;;
              *)
                echo "Unsupported runtime_target: $runtime_target"
                exit 1
                ;;
            esac
          else
            if [ "${ENABLE_HELM_DEPLOY:-false}" = "true" ]; then
              deploy_helm=true
            fi
            if [ "${ENABLE_RAILWAY_DEPLOY:-false}" = "true" ]; then
              deploy_railway=true
            fi
          fi

          rollback_tag=""
          if [ "$deploy_helm" = "true" ] || [ "$deploy_railway" = "true" ]; then
            runs_json=$(curl -fsSL \
              -H "Authorization: Bearer ${GITHUB_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${{ github.repository }}/actions/workflows/publish-images.yml/runs?status=success&per_page=20")

            rollback_tag=$(echo "$runs_json" | jq -r \
              --arg current_sha "$image_tag" \
              --arg current_run_id "${CURRENT_WORKFLOW_RUN_ID:-}" \
              '.workflow_runs
                | map(select((.id|tostring) != $current_run_id))
                | map(.head_sha)
                | map(select(. != $current_sha))
                | .[0] // ""')
          fi

          {
            echo "image_tag=$image_tag"
            echo "api_image=$api_image"
            echo "worker_image=$worker_image"
            echo "deploy_helm=$deploy_helm"
            echo "deploy_railway=$deploy_railway"
            echo "runtime_target=$runtime_target"
            echo "rollback_tag=$rollback_tag"
          } >> "$GITHUB_OUTPUT"

      - name: Print deployment plan
        run: |
          echo "image_tag=${{ steps.resolve.outputs.image_tag }}"
          echo "api_image=${{ steps.resolve.outputs.api_image }}"
          echo "worker_image=${{ steps.resolve.outputs.worker_image }}"
          echo "deploy_helm=${{ steps.resolve.outputs.deploy_helm }}"
          echo "deploy_railway=${{ steps.resolve.outputs.deploy_railway }}"
          echo "rollback_tag=${{ steps.resolve.outputs.rollback_tag }}"
          if [ "${{ steps.resolve.outputs.deploy_helm }}" != "true" ] && [ "${{ steps.resolve.outputs.deploy_railway }}" != "true" ]; then
            echo "No runtime target enabled. Set ENABLE_HELM_DEPLOY/ENABLE_RAILWAY_DEPLOY or run manually with workflow_dispatch."
          fi

  deploy_helm:
    name: Deploy Helm Runtime
    needs: prepare
    if: ${{ needs.prepare.outputs.deploy_helm == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment:
      name: ${{ vars.DEPLOY_ENVIRONMENT || 'production' }}
    outputs:
      api_ref: ${{ steps.resolve_digests.outputs.api_ref }}
      worker_ref: ${{ steps.resolve_digests.outputs.worker_ref }}
    env:
      IMAGE_TAG: ${{ needs.prepare.outputs.image_tag }}
      API_IMAGE: ${{ needs.prepare.outputs.api_image }}
      WORKER_IMAGE: ${{ needs.prepare.outputs.worker_image }}
      HELM_RELEASE_NAME: ${{ vars.HELM_RELEASE_NAME || 'provenance' }}
      HELM_NAMESPACE: ${{ vars.HELM_NAMESPACE || 'provenance' }}
      KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
      ENABLE_COSIGN_VERIFY: ${{ vars.ENABLE_COSIGN_VERIFY || 'false' }}
      COSIGN_PUBLIC_KEY: ${{ secrets.COSIGN_PUBLIC_KEY }}
    steps:
      - uses: actions/checkout@v4
      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Require kubeconfig secret
        run: |
          if [ -z "${KUBE_CONFIG_DATA}" ]; then
            echo "KUBE_CONFIG_DATA secret is required for Helm deploy."
            exit 1
          fi

      - name: Configure kubeconfig
        run: |
          set -euo pipefail
          mkdir -p ~/.kube
          if echo "${KUBE_CONFIG_DATA}" | base64 --decode > ~/.kube/config 2>/dev/null; then
            echo "Loaded kubeconfig from base64 secret"
          else
            printf '%s' "${KUBE_CONFIG_DATA}" > ~/.kube/config
            echo "Loaded kubeconfig from plain-text secret"
          fi
          chmod 600 ~/.kube/config

      - name: Pull pinned images from GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
          docker pull "${API_IMAGE}"
          docker pull "${WORKER_IMAGE}"

      - name: Resolve image digests
        id: resolve_digests
        run: |
          set -euo pipefail
          api_digest=$(docker image inspect --format='{{index .RepoDigests 0}}' "${API_IMAGE}" | cut -d'@' -f2)
          worker_digest=$(docker image inspect --format='{{index .RepoDigests 0}}' "${WORKER_IMAGE}" | cut -d'@' -f2)
          api_ref="ghcr.io/${{ github.repository_owner }}/provenance-api@${api_digest}"
          worker_ref="ghcr.io/${{ github.repository_owner }}/provenance-worker@${worker_digest}"
          {
            echo "api_digest=$api_digest"
            echo "worker_digest=$worker_digest"
            echo "api_ref=$api_ref"
            echo "worker_ref=$worker_ref"
          } >> "$GITHUB_OUTPUT"

      - name: Install cosign
        if: ${{ env.ENABLE_COSIGN_VERIFY == 'true' }}
        uses: sigstore/cosign-installer@v4.0.0

      - name: Verify image signatures
        if: ${{ env.ENABLE_COSIGN_VERIFY == 'true' }}
        run: |
          set -euo pipefail
          if [ -z "${COSIGN_PUBLIC_KEY}" ]; then
            echo "COSIGN_PUBLIC_KEY secret is required when ENABLE_COSIGN_VERIFY=true."
            exit 1
          fi
          printf '%s' "${COSIGN_PUBLIC_KEY}" > cosign.pub
          cosign verify --key cosign.pub "${{ steps.resolve_digests.outputs.api_ref }}"
          cosign verify --key cosign.pub "${{ steps.resolve_digests.outputs.worker_ref }}"

      - name: Deploy pinned tag with Helm
        run: |
          helm upgrade --install "${HELM_RELEASE_NAME}" deploy/helm/provenance-stack \
            --namespace "${HELM_NAMESPACE}" \
            --create-namespace \
            --set api.image.repository="ghcr.io/${{ github.repository_owner }}/provenance-api" \
            --set api.image.tag="${IMAGE_TAG}" \
            --set api.image.digest="${{ steps.resolve_digests.outputs.api_digest }}" \
            --set worker.image.repository="ghcr.io/${{ github.repository_owner }}/provenance-worker" \
            --set worker.image.tag="${IMAGE_TAG}" \
            --set worker.image.digest="${{ steps.resolve_digests.outputs.worker_digest }}" \
            --wait \
            --timeout 10m

      - name: Show Helm release status
        run: |
          helm status "${HELM_RELEASE_NAME}" --namespace "${HELM_NAMESPACE}"

  deploy_railway:
    name: Deploy Railway Runtime
    needs: prepare
    if: ${{ needs.prepare.outputs.deploy_railway == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment:
      name: ${{ vars.DEPLOY_ENVIRONMENT || 'production' }}
    outputs:
      api_ref: ${{ steps.resolve_digests.outputs.api_ref }}
      worker_ref: ${{ steps.resolve_digests.outputs.worker_ref }}
    env:
      IMAGE_TAG: ${{ needs.prepare.outputs.image_tag }}
      API_IMAGE: ${{ needs.prepare.outputs.api_image }}
      WORKER_IMAGE: ${{ needs.prepare.outputs.worker_image }}
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN || secrets.RAILWAY_TOKEN }}
      RAILWAY_WORKSPACE: ${{ vars.RAILWAY_WORKSPACE }}
      RAILWAY_PROJECT: ${{ vars.RAILWAY_PROJECT }}
      RAILWAY_ENVIRONMENT: ${{ vars.RAILWAY_ENVIRONMENT }}
      RAILWAY_API_SERVICE: ${{ vars.RAILWAY_API_SERVICE }}
      RAILWAY_WORKER_SERVICE: ${{ vars.RAILWAY_WORKER_SERVICE }}
      ENABLE_COSIGN_VERIFY: ${{ vars.ENABLE_COSIGN_VERIFY || 'false' }}
      COSIGN_PUBLIC_KEY: ${{ secrets.COSIGN_PUBLIC_KEY }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Require Railway configuration
        run: |
          set -euo pipefail
          token_candidate="${RAILWAY_API_TOKEN:-${RAILWAY_TOKEN:-}}"
          missing=()
          if [ -z "${token_candidate}" ]; then
            missing+=("RAILWAY_API_TOKEN_OR_RAILWAY_TOKEN")
          fi
          for key in RAILWAY_PROJECT RAILWAY_ENVIRONMENT RAILWAY_API_SERVICE; do
            if [ -z "${!key:-}" ]; then
              missing+=("$key")
            fi
          done
          if [ "${#missing[@]}" -gt 0 ]; then
            echo "Missing required Railway config: ${missing[*]}"
            echo "Set repository secret/variables before enabling Railway deploy."
            exit 1
          fi

      - name: Normalize Railway token env
        run: |
          set -euo pipefail
          token="${RAILWAY_API_TOKEN:-${RAILWAY_TOKEN:-}}"
          token="$(printf '%s' "${token}" | tr -d '\r\n')"
          {
            echo "RAILWAY_API_TOKEN=${token}"
            echo "RAILWAY_TOKEN=${token}"
          } >> "$GITHUB_ENV"

      - name: Probe Railway auth (non-blocking)
        run: |
          set -euo pipefail
          if ! railway whoami --json; then
            echo "Railway auth probe failed (non-blocking)."
            echo "Continuing to link/deploy because workspace/project scoped tokens may not support whoami."
          fi

      - name: Link Railway project and environment
        id: railway_link
        run: |
          set -euo pipefail
          link_failed=false
          cmd=(railway link --project "${RAILWAY_PROJECT}" --environment "${RAILWAY_ENVIRONMENT}")
          if [ -n "${RAILWAY_WORKSPACE:-}" ]; then
            cmd+=(--workspace "${RAILWAY_WORKSPACE}")
          fi
          if ! "${cmd[@]}"; then
            if [ "${{ github.event_name }}" = "workflow_run" ]; then
              link_failed=true
              echo "Railway link failed for automatic run; deploy steps will be skipped."
              echo "Check token access to project=${RAILWAY_PROJECT} environment=${RAILWAY_ENVIRONMENT} workspace=${RAILWAY_WORKSPACE:-<unset>}."
            else
              echo "Railway link failed."
              echo "Check that your token is valid and account-scoped for workspace projects."
              echo "Check token access to project=${RAILWAY_PROJECT} environment=${RAILWAY_ENVIRONMENT} workspace=${RAILWAY_WORKSPACE:-<unset>}."
              exit 1
            fi
          fi
          echo "link_failed=${link_failed}" >> "$GITHUB_OUTPUT"

      - name: Skip automatic Railway deploy when link/auth fails
        if: ${{ github.event_name == 'workflow_run' && steps.railway_link.outputs.link_failed == 'true' }}
        run: |
          echo "Skipping Railway pin/redeploy for this automatic run."
          echo "Reason: Railway token cannot link to configured project/environment."
          echo "Fix token/permissions and run this workflow manually if you need immediate deploy."

      - name: Pull pinned images from GHCR
        if: ${{ steps.railway_link.outputs.link_failed != 'true' }}
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
          docker pull "${API_IMAGE}"
          if [ -n "${RAILWAY_WORKER_SERVICE:-}" ]; then
            docker pull "${WORKER_IMAGE}"
          fi

      - name: Resolve image digests
        id: resolve_digests
        if: ${{ steps.railway_link.outputs.link_failed != 'true' }}
        run: |
          set -euo pipefail
          api_digest=$(docker image inspect --format='{{index .RepoDigests 0}}' "${API_IMAGE}" | cut -d'@' -f2)
          api_ref="ghcr.io/${{ github.repository_owner }}/provenance-api@${api_digest}"

          worker_ref=""
          if [ -n "${RAILWAY_WORKER_SERVICE:-}" ]; then
            worker_digest=$(docker image inspect --format='{{index .RepoDigests 0}}' "${WORKER_IMAGE}" | cut -d'@' -f2)
            worker_ref="ghcr.io/${{ github.repository_owner }}/provenance-worker@${worker_digest}"
          fi

          {
            echo "api_ref=$api_ref"
            echo "worker_ref=$worker_ref"
          } >> "$GITHUB_OUTPUT"

      - name: Install cosign
        if: ${{ steps.railway_link.outputs.link_failed != 'true' && env.ENABLE_COSIGN_VERIFY == 'true' }}
        uses: sigstore/cosign-installer@v4.0.0

      - name: Verify image signatures
        if: ${{ steps.railway_link.outputs.link_failed != 'true' && env.ENABLE_COSIGN_VERIFY == 'true' }}
        run: |
          set -euo pipefail
          if [ -z "${COSIGN_PUBLIC_KEY}" ]; then
            echo "COSIGN_PUBLIC_KEY secret is required when ENABLE_COSIGN_VERIFY=true."
            exit 1
          fi
          printf '%s' "${COSIGN_PUBLIC_KEY}" > cosign.pub
          cosign verify --key cosign.pub "${{ steps.resolve_digests.outputs.api_ref }}"
          if [ -n "${{ steps.resolve_digests.outputs.worker_ref }}" ]; then
            cosign verify --key cosign.pub "${{ steps.resolve_digests.outputs.worker_ref }}"
          fi

      - name: Pin and redeploy Railway API service
        if: ${{ steps.railway_link.outputs.link_failed != 'true' }}
        run: |
          set -euo pipefail
          railway environment edit \
            --environment "${RAILWAY_ENVIRONMENT}" \
            --service-config "${RAILWAY_API_SERVICE}" source.image "${{ steps.resolve_digests.outputs.api_ref }}" \
            --message "ci: pin ${RAILWAY_API_SERVICE} image ${IMAGE_TAG}" \
            --json
          railway redeploy --service "${RAILWAY_API_SERVICE}" --yes --json

      - name: Pin and redeploy Railway worker service (optional)
        if: ${{ steps.railway_link.outputs.link_failed != 'true' && env.RAILWAY_WORKER_SERVICE != '' }}
        run: |
          set -euo pipefail
          railway environment edit \
            --environment "${RAILWAY_ENVIRONMENT}" \
            --service-config "${RAILWAY_WORKER_SERVICE}" source.image "${{ steps.resolve_digests.outputs.worker_ref }}" \
            --message "ci: pin ${RAILWAY_WORKER_SERVICE} image ${IMAGE_TAG}" \
            --json
          railway redeploy --service "${RAILWAY_WORKER_SERVICE}" --yes --json

  smoke_gate:
    name: Post-Deploy Smoke Gate
    needs: [prepare, deploy_helm, deploy_railway]
    if: ${{ always() && (needs['deploy_helm'].result == 'success' || needs['deploy_railway'].result == 'success') }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      ENABLE_DEPLOY_SMOKE_GATE: ${{ vars.ENABLE_DEPLOY_SMOKE_GATE || 'false' }}
      PRODUCTION_API_URL: ${{ secrets.PRODUCTION_API_URL }}
      PRODUCTION_API_KEY: ${{ secrets.PRODUCTION_API_KEY }}
      PRODUCTION_API_KEY_HEADER: ${{ vars.PRODUCTION_API_KEY_HEADER || 'X-API-Key' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Skip smoke gate when disabled
        if: ${{ env.ENABLE_DEPLOY_SMOKE_GATE != 'true' }}
        run: echo "ENABLE_DEPLOY_SMOKE_GATE is not true; skipping smoke gate."

      - name: Require URL when smoke gate enabled
        if: ${{ env.ENABLE_DEPLOY_SMOKE_GATE == 'true' && env.PRODUCTION_API_URL == '' }}
        run: |
          echo "PRODUCTION_API_URL secret is required when ENABLE_DEPLOY_SMOKE_GATE=true."
          exit 1

      - name: Install backend dependencies
        if: ${{ env.ENABLE_DEPLOY_SMOKE_GATE == 'true' && env.PRODUCTION_API_URL != '' }}
        run: |
          cd backend
          pip install -e .

      - name: Run smoke suite
        if: ${{ env.ENABLE_DEPLOY_SMOKE_GATE == 'true' && env.PRODUCTION_API_URL != '' }}
        run: |
          cd backend
          python scripts/smoke_detect_prod.py \
            --base-url "${PRODUCTION_API_URL}" \
            --api-key "${PRODUCTION_API_KEY}" \
            --api-key-header "${PRODUCTION_API_KEY_HEADER}" \
            --output ./evidence/smoke/prod_detect_smoke.json

      - name: Upload smoke artifact
        if: ${{ always() && env.ENABLE_DEPLOY_SMOKE_GATE == 'true' && env.PRODUCTION_API_URL != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: deploy-smoke-artifact
          path: backend/evidence/smoke/prod_detect_smoke.json
          retention-days: 14

  rollback_helm:
    name: Rollback Helm Runtime
    needs: [prepare, deploy_helm, smoke_gate]
    if: ${{ always() && vars.ENABLE_AUTO_ROLLBACK == 'true' && needs['deploy_helm'].result == 'success' && needs['smoke_gate'].result == 'failure' && needs.prepare.outputs.rollback_tag != '' }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment:
      name: ${{ vars.DEPLOY_ENVIRONMENT || 'production' }}
    env:
      ROLLBACK_TAG: ${{ needs.prepare.outputs.rollback_tag }}
      KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
      HELM_RELEASE_NAME: ${{ vars.HELM_RELEASE_NAME || 'provenance' }}
      HELM_NAMESPACE: ${{ vars.HELM_NAMESPACE || 'provenance' }}
      ENABLE_COSIGN_VERIFY: ${{ vars.ENABLE_COSIGN_VERIFY || 'false' }}
      COSIGN_PUBLIC_KEY: ${{ secrets.COSIGN_PUBLIC_KEY }}
    steps:
      - uses: actions/checkout@v4
      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Configure kubeconfig
        run: |
          set -euo pipefail
          if [ -z "${KUBE_CONFIG_DATA}" ]; then
            echo "KUBE_CONFIG_DATA secret is required for Helm rollback."
            exit 1
          fi
          mkdir -p ~/.kube
          if echo "${KUBE_CONFIG_DATA}" | base64 --decode > ~/.kube/config 2>/dev/null; then
            echo "Loaded kubeconfig from base64 secret"
          else
            printf '%s' "${KUBE_CONFIG_DATA}" > ~/.kube/config
            echo "Loaded kubeconfig from plain-text secret"
          fi
          chmod 600 ~/.kube/config

      - name: Pull rollback images from GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
          docker pull "ghcr.io/${{ github.repository_owner }}/provenance-api:${ROLLBACK_TAG}"
          docker pull "ghcr.io/${{ github.repository_owner }}/provenance-worker:${ROLLBACK_TAG}"

      - name: Resolve rollback digests
        id: resolve_digests
        run: |
          set -euo pipefail
          api_digest=$(docker image inspect --format='{{index .RepoDigests 0}}' "ghcr.io/${{ github.repository_owner }}/provenance-api:${ROLLBACK_TAG}" | cut -d'@' -f2)
          worker_digest=$(docker image inspect --format='{{index .RepoDigests 0}}' "ghcr.io/${{ github.repository_owner }}/provenance-worker:${ROLLBACK_TAG}" | cut -d'@' -f2)
          {
            echo "api_digest=$api_digest"
            echo "worker_digest=$worker_digest"
            echo "api_ref=ghcr.io/${{ github.repository_owner }}/provenance-api@${api_digest}"
            echo "worker_ref=ghcr.io/${{ github.repository_owner }}/provenance-worker@${worker_digest}"
          } >> "$GITHUB_OUTPUT"

      - name: Install cosign
        if: ${{ env.ENABLE_COSIGN_VERIFY == 'true' }}
        uses: sigstore/cosign-installer@v4.0.0

      - name: Verify rollback image signatures
        if: ${{ env.ENABLE_COSIGN_VERIFY == 'true' }}
        run: |
          set -euo pipefail
          if [ -z "${COSIGN_PUBLIC_KEY}" ]; then
            echo "COSIGN_PUBLIC_KEY secret is required when ENABLE_COSIGN_VERIFY=true."
            exit 1
          fi
          printf '%s' "${COSIGN_PUBLIC_KEY}" > cosign.pub
          cosign verify --key cosign.pub "${{ steps.resolve_digests.outputs.api_ref }}"
          cosign verify --key cosign.pub "${{ steps.resolve_digests.outputs.worker_ref }}"

      - name: Roll back Helm release to previous SHA
        run: |
          helm upgrade --install "${HELM_RELEASE_NAME}" deploy/helm/provenance-stack \
            --namespace "${HELM_NAMESPACE}" \
            --create-namespace \
            --set api.image.repository="ghcr.io/${{ github.repository_owner }}/provenance-api" \
            --set api.image.tag="${ROLLBACK_TAG}" \
            --set api.image.digest="${{ steps.resolve_digests.outputs.api_digest }}" \
            --set worker.image.repository="ghcr.io/${{ github.repository_owner }}/provenance-worker" \
            --set worker.image.tag="${ROLLBACK_TAG}" \
            --set worker.image.digest="${{ steps.resolve_digests.outputs.worker_digest }}" \
            --wait \
            --timeout 10m

  rollback_railway:
    name: Rollback Railway Runtime
    needs: [prepare, deploy_railway, smoke_gate]
    if: ${{ always() && vars.ENABLE_AUTO_ROLLBACK == 'true' && needs['deploy_railway'].result == 'success' && needs['smoke_gate'].result == 'failure' && needs.prepare.outputs.rollback_tag != '' }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment:
      name: ${{ vars.DEPLOY_ENVIRONMENT || 'production' }}
    env:
      ROLLBACK_TAG: ${{ needs.prepare.outputs.rollback_tag }}
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN || secrets.RAILWAY_TOKEN }}
      RAILWAY_WORKSPACE: ${{ vars.RAILWAY_WORKSPACE }}
      RAILWAY_PROJECT: ${{ vars.RAILWAY_PROJECT }}
      RAILWAY_ENVIRONMENT: ${{ vars.RAILWAY_ENVIRONMENT }}
      RAILWAY_API_SERVICE: ${{ vars.RAILWAY_API_SERVICE }}
      RAILWAY_WORKER_SERVICE: ${{ vars.RAILWAY_WORKER_SERVICE }}
      ENABLE_COSIGN_VERIFY: ${{ vars.ENABLE_COSIGN_VERIFY || 'false' }}
      COSIGN_PUBLIC_KEY: ${{ secrets.COSIGN_PUBLIC_KEY }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Require Railway rollback configuration
        run: |
          set -euo pipefail
          token_candidate="${RAILWAY_API_TOKEN:-${RAILWAY_TOKEN:-}}"
          missing=()
          if [ -z "${token_candidate}" ]; then
            missing+=("RAILWAY_API_TOKEN_OR_RAILWAY_TOKEN")
          fi
          for key in RAILWAY_PROJECT RAILWAY_ENVIRONMENT RAILWAY_API_SERVICE; do
            if [ -z "${!key:-}" ]; then
              missing+=("$key")
            fi
          done
          if [ "${#missing[@]}" -gt 0 ]; then
            echo "Missing required Railway config for rollback: ${missing[*]}"
            exit 1
          fi

      - name: Normalize Railway token env
        run: |
          set -euo pipefail
          token="${RAILWAY_API_TOKEN:-${RAILWAY_TOKEN:-}}"
          token="$(printf '%s' "${token}" | tr -d '\r\n')"
          {
            echo "RAILWAY_API_TOKEN=${token}"
            echo "RAILWAY_TOKEN=${token}"
          } >> "$GITHUB_ENV"

      - name: Probe Railway auth (non-blocking)
        run: |
          set -euo pipefail
          if ! railway whoami --json; then
            echo "Railway auth probe failed (non-blocking)."
            echo "Continuing to link/rollback because workspace/project scoped tokens may not support whoami."
          fi

      - name: Link Railway project and environment
        run: |
          set -euo pipefail
          cmd=(railway link --project "${RAILWAY_PROJECT}" --environment "${RAILWAY_ENVIRONMENT}")
          if [ -n "${RAILWAY_WORKSPACE:-}" ]; then
            cmd+=(--workspace "${RAILWAY_WORKSPACE}")
          fi
          if ! "${cmd[@]}"; then
            echo "Railway link failed during rollback."
            echo "Check that your token is valid and account-scoped for workspace projects."
            echo "Check token access to project=${RAILWAY_PROJECT} environment=${RAILWAY_ENVIRONMENT} workspace=${RAILWAY_WORKSPACE:-<unset>}."
            exit 1
          fi

      - name: Pull rollback images from GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
          docker pull "ghcr.io/${{ github.repository_owner }}/provenance-api:${ROLLBACK_TAG}"
          if [ -n "${RAILWAY_WORKER_SERVICE:-}" ]; then
            docker pull "ghcr.io/${{ github.repository_owner }}/provenance-worker:${ROLLBACK_TAG}"
          fi

      - name: Resolve rollback digests
        id: resolve_digests
        run: |
          set -euo pipefail
          api_digest=$(docker image inspect --format='{{index .RepoDigests 0}}' "ghcr.io/${{ github.repository_owner }}/provenance-api:${ROLLBACK_TAG}" | cut -d'@' -f2)
          api_ref="ghcr.io/${{ github.repository_owner }}/provenance-api@${api_digest}"

          worker_ref=""
          if [ -n "${RAILWAY_WORKER_SERVICE:-}" ]; then
            worker_digest=$(docker image inspect --format='{{index .RepoDigests 0}}' "ghcr.io/${{ github.repository_owner }}/provenance-worker:${ROLLBACK_TAG}" | cut -d'@' -f2)
            worker_ref="ghcr.io/${{ github.repository_owner }}/provenance-worker@${worker_digest}"
          fi

          {
            echo "api_ref=$api_ref"
            echo "worker_ref=$worker_ref"
          } >> "$GITHUB_OUTPUT"

      - name: Install cosign
        if: ${{ env.ENABLE_COSIGN_VERIFY == 'true' }}
        uses: sigstore/cosign-installer@v4.0.0

      - name: Verify rollback image signatures
        if: ${{ env.ENABLE_COSIGN_VERIFY == 'true' }}
        run: |
          set -euo pipefail
          if [ -z "${COSIGN_PUBLIC_KEY}" ]; then
            echo "COSIGN_PUBLIC_KEY secret is required when ENABLE_COSIGN_VERIFY=true."
            exit 1
          fi
          printf '%s' "${COSIGN_PUBLIC_KEY}" > cosign.pub
          cosign verify --key cosign.pub "${{ steps.resolve_digests.outputs.api_ref }}"
          if [ -n "${{ steps.resolve_digests.outputs.worker_ref }}" ]; then
            cosign verify --key cosign.pub "${{ steps.resolve_digests.outputs.worker_ref }}"
          fi

      - name: Roll back Railway API service
        run: |
          set -euo pipefail
          railway environment edit \
            --environment "${RAILWAY_ENVIRONMENT}" \
            --service-config "${RAILWAY_API_SERVICE}" source.image "${{ steps.resolve_digests.outputs.api_ref }}" \
            --message "ci: rollback ${RAILWAY_API_SERVICE} to ${ROLLBACK_TAG}" \
            --json
          railway redeploy --service "${RAILWAY_API_SERVICE}" --yes --json

      - name: Roll back Railway worker service (optional)
        if: ${{ env.RAILWAY_WORKER_SERVICE != '' }}
        run: |
          set -euo pipefail
          railway environment edit \
            --environment "${RAILWAY_ENVIRONMENT}" \
            --service-config "${RAILWAY_WORKER_SERVICE}" source.image "${{ steps.resolve_digests.outputs.worker_ref }}" \
            --message "ci: rollback ${RAILWAY_WORKER_SERVICE} to ${ROLLBACK_TAG}" \
            --json
          railway redeploy --service "${RAILWAY_WORKER_SERVICE}" --yes --json

  deployment-summary:
    name: Deployment Summary
    needs: [prepare, deploy_helm, deploy_railway, smoke_gate, rollback_helm, rollback_railway]
    if: ${{ always() }}
    runs-on: ubuntu-latest
    steps:
      - name: Build deployment summary artifact
        env:
          IMAGE_TAG: ${{ needs.prepare.outputs.image_tag }}
          ROLLBACK_TAG: ${{ needs.prepare.outputs.rollback_tag }}
          RUNTIME_TARGET: ${{ needs.prepare.outputs.runtime_target }}
          DEPLOY_HELM_REQUESTED: ${{ needs.prepare.outputs.deploy_helm }}
          DEPLOY_RAILWAY_REQUESTED: ${{ needs.prepare.outputs.deploy_railway }}
          DEPLOY_HELM_RESULT: ${{ needs['deploy_helm'].result }}
          DEPLOY_RAILWAY_RESULT: ${{ needs['deploy_railway'].result }}
          DEPLOY_HELM_API_REF: ${{ needs.deploy_helm.outputs.api_ref }}
          DEPLOY_HELM_WORKER_REF: ${{ needs.deploy_helm.outputs.worker_ref }}
          DEPLOY_RAILWAY_API_REF: ${{ needs.deploy_railway.outputs.api_ref }}
          DEPLOY_RAILWAY_WORKER_REF: ${{ needs.deploy_railway.outputs.worker_ref }}
          SMOKE_RESULT: ${{ needs['smoke_gate'].result }}
          ROLLBACK_HELM_RESULT: ${{ needs['rollback_helm'].result }}
          ROLLBACK_RAILWAY_RESULT: ${{ needs['rollback_railway'].result }}
          ENABLE_SMOKE_GATE: ${{ vars.ENABLE_DEPLOY_SMOKE_GATE || 'false' }}
          ENABLE_AUTO_ROLLBACK: ${{ vars.ENABLE_AUTO_ROLLBACK || 'false' }}
          ENABLE_COSIGN_VERIFY: ${{ vars.ENABLE_COSIGN_VERIFY || 'false' }}
        run: |
          set -euo pipefail
          mkdir -p artifacts

          cat > artifacts/deploy_runtime_summary.json <<JSON
          {
            "workflow": "Deploy Runtime (Pinned SHA)",
            "repository": "${{ github.repository }}",
            "run_id": "${{ github.run_id }}",
            "run_attempt": "${{ github.run_attempt }}",
            "trigger": "${{ github.event_name }}",
            "runtime_target": "${RUNTIME_TARGET:-}",
            "image_tag": "${IMAGE_TAG:-}",
            "rollback_tag": "${ROLLBACK_TAG:-}",
            "deploy_requested": {
              "helm": "${DEPLOY_HELM_REQUESTED:-false}",
              "railway": "${DEPLOY_RAILWAY_REQUESTED:-false}"
            },
            "deployed_refs": {
              "helm_api": "${DEPLOY_HELM_API_REF:-}",
              "helm_worker": "${DEPLOY_HELM_WORKER_REF:-}",
              "railway_api": "${DEPLOY_RAILWAY_API_REF:-}",
              "railway_worker": "${DEPLOY_RAILWAY_WORKER_REF:-}"
            },
            "job_results": {
              "deploy_helm": "${DEPLOY_HELM_RESULT:-skipped}",
              "deploy_railway": "${DEPLOY_RAILWAY_RESULT:-skipped}",
              "smoke_gate": "${SMOKE_RESULT:-skipped}",
              "rollback_helm": "${ROLLBACK_HELM_RESULT:-skipped}",
              "rollback_railway": "${ROLLBACK_RAILWAY_RESULT:-skipped}"
            },
            "controls": {
              "smoke_gate_enabled": "${ENABLE_SMOKE_GATE}",
              "auto_rollback_enabled": "${ENABLE_AUTO_ROLLBACK}",
              "cosign_verify_enabled": "${ENABLE_COSIGN_VERIFY}"
            }
          }
          JSON

          {
            echo "## Deploy Runtime Summary"
            echo ""
            echo "- Image tag: ${IMAGE_TAG:-n/a}"
            echo "- Runtime target: ${RUNTIME_TARGET:-n/a}"
            echo "- Deploy Helm: ${DEPLOY_HELM_RESULT:-skipped}"
            echo "- Deploy Railway: ${DEPLOY_RAILWAY_RESULT:-skipped}"
            echo "- Helm API ref: ${DEPLOY_HELM_API_REF:-n/a}"
            echo "- Railway API ref: ${DEPLOY_RAILWAY_API_REF:-n/a}"
            echo "- Smoke gate: ${SMOKE_RESULT:-skipped}"
            echo "- Rollback tag candidate: ${ROLLBACK_TAG:-none}"
            echo "- Rollback Helm: ${ROLLBACK_HELM_RESULT:-skipped}"
            echo "- Rollback Railway: ${ROLLBACK_RAILWAY_RESULT:-skipped}"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload deployment summary artifact
        uses: actions/upload-artifact@v4
        with:
          name: deploy-runtime-summary
          path: artifacts/deploy_runtime_summary.json
          retention-days: 30
